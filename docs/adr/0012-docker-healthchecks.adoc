= ADR-0012: Implementa√ß√£o de Docker Healthchecks

**Status:** Aceito +
**Data:** 2025-07-03 +
**Autor:** DevFerreiraG

== Contexto

O sistema de consulta de cr√©ditos opera em ambiente containerizado com m√∫ltiplos servi√ßos (API Spring Boot, PostgreSQL, Kafka). A aus√™ncia de healthchecks adequados pode resultar em falhas silenciosas, dificuldade de debugging e problemas de orquestra√ß√£o em ambientes de produ√ß√£o.

== Decis√£o

Implementaremos **healthchecks nativos Docker** para todos os servi√ßos cr√≠ticos, garantindo monitoramento proativo e recupera√ß√£o autom√°tica de falhas.

== Alternativas Consideradas

1. **Apenas logs de aplica√ß√£o** - Reativo, dificulta detec√ß√£o precoce
2. **Monitoring externo (Prometheus)** - Complexidade adicional
3. **Spring Boot Actuator apenas** - Limitado ao contexto da aplica√ß√£o
4. **Docker healthchecks nativos** - **ESCOLHIDO**

== Justificativa

=== Vantagens dos Docker Healthchecks

* **Orquestra√ß√£o inteligente:** Docker Compose/Swarm aguarda servi√ßos saud√°veis
* **Recovery autom√°tico:** Restart de containers n√£o-saud√°veis
* **Visibilidade:** `docker ps` mostra status de sa√∫de em tempo real
* **Zero overhead:** Executados pelo daemon Docker
* **Padroniza√ß√£o:** Funciona independente da linguagem/framework

== Implementa√ß√£o por Servi√ßo

=== Spring Boot API

[source,yaml]
----
# docker-compose.yml
services:
  creditos-api:
    build: ./creditos-api
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_healthy
----

=== PostgreSQL 17

[source,yaml]
----
services:
  postgres:
    image: postgres:17.5-alpine
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d creditos"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    environment:
      POSTGRES_DB: creditos
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
----

=== Apache Kafka

[source,yaml]
----
services:
  kafka:
    image: confluentinc/cp-kafka:7.6.0
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      zookeeper:
        condition: service_healthy
----

=== Zookeeper (Kafka Dependency)

[source,yaml]
----
services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.0
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
----

== Configura√ß√µes de Tuning

=== Timing Strategies

* **start_period:** Tempo de "grace" antes dos healthchecks iniciarem
* **interval:** Frequ√™ncia de verifica√ß√£o (balancear performance vs. detec√ß√£o)
* **timeout:** Tempo m√°ximo por verifica√ß√£o
* **retries:** Tentativas antes de marcar como unhealthy

=== Ambiente de Desenvolvimento

[source,yaml]
----
# docker-compose.dev.yml
services:
  creditos-api:
    healthcheck:
      interval: 15s    # Verifica√ß√£o mais frequente
      timeout: 5s      # Timeout reduzido
      start_period: 20s # Start mais r√°pido
----

=== Ambiente de Produ√ß√£o

[source,yaml]
----
# docker-compose.prod.yml
services:
  creditos-api:
    healthcheck:
      interval: 60s    # Menos overhead
      timeout: 30s     # Timeout generoso
      start_period: 90s # Mais tempo para warm-up
----

== Integra√ß√£o com Spring Boot Actuator

=== Endpoint Customizado

[source,java]
----
@Component
public class CustomHealthIndicator implements HealthIndicator {
    
    @Autowired
    private KafkaTemplate<String, Object> kafkaTemplate;
    
    @Autowired
    private DataSource dataSource;
    
    @Override
    public Health health() {
        try {
            // Verificar conectividade Kafka
            kafkaTemplate.metrics();
            
            // Verificar pool de conex√µes DB
            try (Connection conn = dataSource.getConnection()) {
                conn.isValid(5);
            }
            
            return Health.up()
                    .withDetail("kafka", "CONNECTED")
                    .withDetail("database", "CONNECTED")
                    .withDetail("timestamp", Instant.now())
                    .build();
                    
        } catch (Exception e) {
            return Health.down()
                    .withDetail("error", e.getMessage())
                    .withDetail("timestamp", Instant.now())
                    .build();
        }
    }
}
----

== Consequ√™ncias

=== Positivas
* **Startup ordenado:** Servi√ßos dependentes aguardam dependencies
* **Recovery autom√°tico:** Containers problem√°ticos s√£o reiniciados
* **Debugging facilitado:** Status vis√≠vel em `docker ps`
* **CI/CD confi√°vel:** Testes aguardam stack completamente funcional

=== Negativas
* **Overhead m√≠nimo:** Execu√ß√£o de comandos peri√≥dicos
* **Configura√ß√£o adicional:** Cada servi√ßo precisa de healthcheck espec√≠fico
* **False positives:** Healthchecks podem falhar por sobrecarga tempor√°ria

== Monitoramento e Alertas

=== Comandos de Verifica√ß√£o

[source,bash]
----
# Status geral dos healthchecks
docker compose ps

# Logs detalhados de healthcheck
docker inspect --format='{{.State.Health}}' container_name

# Hist√≥rico de healthchecks
docker inspect --format='{{range .State.Health.Log}}{{.Output}}{{end}}' container_name
----

=== Integra√ß√£o com Monitoring

[source,yaml]
----
# docker-compose.monitoring.yml
services:
  docker-exporter:
    image: prometheuscommunity/dockerhub-exporter
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command:
      - '--web.listen-address=0.0.0.0:9417'
      - '--docker.api-version=1.41'
----

== Scripts de Automa√ß√£o

=== Preflight Validation

[source,bash]
----
#!/bin/bash
# preflight.sh - Aguardar todos os servi√ßos ficarem healthy

echo "üöÄ Aguardando servi√ßos ficarem saud√°veis..."

services=("postgres" "kafka" "creditos-api")

for service in "${services[@]}"; do
    echo "‚è≥ Aguardando $service..."
    
    while [ "$(docker compose ps --format json | jq -r --arg svc "$service" '.[] | select(.Service == $svc) | .Health')" != "healthy" ]; do
        sleep 5
        echo "   ... ainda aguardando $service"
    done
    
    echo "‚úÖ $service est√° saud√°vel!"
done

echo "üéâ Todos os servi√ßos est√£o funcionando!"
----

== Refer√™ncias

* https://docs.docker.com/engine/reference/builder/#healthcheck[Docker Healthcheck Reference]
* https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.health[Spring Boot Health Endpoints]
* https://www.baeldung.com/spring-boot-health-indicators[Custom Health Indicators]
* https://docs.docker.com/compose/compose-file/05-services/#depends_on[Docker Compose depends_on]
